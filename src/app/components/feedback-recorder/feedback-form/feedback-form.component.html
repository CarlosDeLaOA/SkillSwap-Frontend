<div class="form-container">
  <div class="form-header">
    <h3>Califica tu sesion</h3>
    <p class="subtitle">Tu opinion nos ayuda a mejorar constantemente</p>
  </div>

  <app-feedback-recorder
    *ngIf="!showForm"
    (audioRecorded)="onAudioRecorded($event)"
    (recordingStateChanged)="onRecordingStateChanged($event)">
  </app-feedback-recorder>

  <div *ngIf="showForm">
    <div class="rating-section">
      <label class="rating-label">Calificacion</label>
      <div class="star-rating-container">
        <div class="stars-wrapper">
          <button *ngFor="let star of getStarArray(); let i = index"
                  class="star-btn"
                  [class.active]="star <= rating"
                  [class.hovered]="star <= hoverRating"
                  [style.--star-index]="i"
                  (click)="setRating(star)"
                  (mouseenter)="setHoverRating(star)"
                  (mouseleave)="setHoverRating(0)"
                  [disabled]="isSubmitting"
                  type="button">
            <i class='bx bxs-star'></i>
          </button>
        </div>
      </div>
      <p class="rating-text" *ngIf="rating > 0">
        {{ getRatingText() }}
      </p>
    </div>

    <div class="transcription-section" *ngIf="recordedFile">
      <label class="section-label">Tu resena de audio</label>

      <div class="transcription-status" [class]="transcriptionStatus.toLowerCase()">
        <div *ngIf="transcriptionStatus === 'UPLOADING' || transcriptionStatus === 'PROCESSING'" class="loading">
          <div class="spinner"></div>
          <p>{{ getTranscriptionStatusText() }}</p>
        </div>

        <div *ngIf="transcriptionStatus === 'COMPLETED'" class="completed">
          <p class="transcription-text">{{ transcription }}</p>
        </div>

        <div *ngIf="transcriptionStatus === 'ERROR'" class="error">
          <p>No se pudo procesar la transcripcion. Puedes dejar tu comentario manualmente.</p>
        </div>
      </div>
    </div>

    <div class="comment-section">
      <label for="comment" class="comment-label">Comentario adicional (opcional)</label>
      <textarea id="comment"
                class="comment-input"
                [(ngModel)]="comment"
                placeholder="Agrega comentarios adicionales a tu resena..."
                rows="4"
                [disabled]="isSubmitting"
                maxlength="1000"></textarea>
      <p class="char-count">{{ comment.length }}/1000</p>
    </div>

    <div class="button-group">
      <button class="btn btn-secondary"
              (click)="cancel()"
              [disabled]="isSubmitting"
              type="button">
        Cancelar
      </button>

      <button class="btn btn-primary"
              (click)="submitFeedback()"
              [disabled]="isSubmitting || rating === 0"
              type="button">
        <span *ngIf="!isSubmitting">Enviar resena</span>
        <span *ngIf="isSubmitting">Enviando...</span>
      </button>
    </div>
  </div>
</div>
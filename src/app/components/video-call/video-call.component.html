<div class="video-call-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Conectando a la videollamada...</p>
      <p *ngIf="retryCount > 0" class="retry-message">
        Reintento {{ retryCount }}/{{ maxRetries }}
      </p>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="!isLoading && errorMessage" class="error-container">
    <div class="error-content">
      <i class='bx bx-error-circle'></i>
      <h2>Error de Conexión</h2>
      <p>{{ errorMessage }}</p>
      <button class="btn-primary" (click)="initializeVideoCall()">
        Reintentar
      </button>
      <button class="btn-secondary" (click)="leaveCall()">
        Volver al Dashboard
      </button>
    </div>
  </div>

  <!-- Video Call Active -->
  <div *ngIf="isConnected && !errorMessage" class="video-call-active">
    
    <!-- Session Info Badge -->
    <div class="session-info-badge">
      <i class='bx bx-time'></i>
      <span class="timer">{{ sessionTimer }}</span>
      <span class="divider">|</span>
      <span class="session-title">Sesión #{{ sessionId }}</span>
      <span *ngIf="videoCallData?.isModerator" class="moderator-badge">
        <i class='bx bx-star'></i> Instructor
      </span>
    </div>

    <!-- ⭐ Recording Indicator (Solo visible cuando está grabando) -->
    <div *ngIf="isRecording" class="recording-indicator">
      <div class="recording-dot"></div>
      <span>GRABANDO {{ recordingDuration }}</span>
    </div>

    <!-- Main Content Area -->
    <div class="content-wrapper">
      
      <!-- Left: Main Video -->
      <div class="left-section">
        <div class="main-video-container">
          <div id="jitsi-container" class="jitsi-container"></div>
        </div>
      </div>

      <!-- Right: Participants Sidebar  -->
<div class="right-sidebar">
  <div 
    *ngFor="let participant of jitsiParticipants; let i = index" 
    class="participant-tile"
    [style.background]="getParticipantColor(i)">
    
    <!-- ⭐ Contenedor para video del participante -->
    <div 
      [id]="'participant-video-' + participant.id" 
      class="participant-video-container">
      <!-- El video se insertará aquí dinámicamente -->
    </div>

    <!-- Avatar/Nombre -->
    <div class="participant-content" [class.has-video]="participant.hasVideo">
      <span class="participant-initials" *ngIf="!participant.hasVideo">{{ participant.initials }}</span>
      <span class="participant-label">{{ participant.displayName }}</span>
    </div>
  </div>
</div>

    </div>

    <!-- Custom Right Buttons (Bottom Right) -->
    <div class="custom-action-buttons">
      <button class="action-btn" title="Participantes" (click)="toggleParticipants()">
        <i class='bx bx-group'></i>
      </button>
      <button class="action-btn" title="Chat" (click)="toggleChat()">
        <i class='bx bx-message-rounded'></i>
      </button>
      <button class="action-btn" title="Documentos" (click)="toggleDocuments()">
        <i class='bx bx-file'></i>
      </button>
      
      <!-- ⭐ Botón de GRABACIÓN (solo instructor, reemplaza el botón de upload) -->
      <button 
        *ngIf="videoCallData?.isModerator && hasGivenConsent" 
        class="action-btn"
        [class.recording-active]="isRecording"
        [title]="isRecording ? 'Detener grabación' : 'Iniciar grabación de audio'" 
        (click)="toggleRecording()">
        <i class='bx' [class.bx-microphone]="!isRecording" [class.bx-stop]="isRecording"></i>
      </button>
    </div>

  </div>
</div>

<!-- Consent Dialog (Consentimiento de Grabación) -->
<div *ngIf="showConsentDialog" class="modal-overlay consent-overlay">
  <div class="modal-content consent-modal">
    <div class="modal-header">
      <h2>
        <i class='bx bx-shield-alt-2'></i>
        Consentimiento de Grabación
      </h2>
    </div>
    <div class="modal-body">
      <p class="consent-text">
        Al unirte a esta sesión, aceptas que el audio de la sesión puede ser grabado 
        automáticamente para su posterior procesamiento mediante IA.
      </p>
      <ul class="consent-list">
        <li><i class='bx bx-check'></i> Solo se graba audio, no video</li>
        <li><i class='bx bx-check'></i> La grabación es iniciada únicamente por el instructor</li>
        <li><i class='bx bx-check'></i> Los archivos son eliminados después del procesamiento IA</li>
        <li><i class='bx bx-check'></i> Se garantiza la privacidad de tus datos</li>
      </ul>
      <p class="consent-warning">
        <i class='bx bx-info-circle'></i>
        Si no aceptas, no podrás unirte a la sesión y las funciones de IA estarán deshabilitadas.
      </p>
    </div>
    <div class="modal-actions">
      <button class="modal-btn btn-primary-consent" (click)="acceptConsent()">
        <i class='bx bx-check-circle'></i>
        Acepto y Unirme
      </button>
      <button class="modal-btn btn-cancel" (click)="declineConsent()">
        No Acepto
      </button>
    </div>
  </div>
</div>

<!-- Permission Dialog -->
<div *ngIf="showPermissionDialog && !showConsentDialog" class="permission-dialog-overlay">
  <div class="permission-dialog">
    <i class='bx bx-video-recording'></i>
    <h2>Permisos Necesarios</h2>
    <p>Para unirte a la videollamada, necesitamos acceso a:</p>
    <ul>
      <li><i class='bx bx-camera'></i> Cámara</li>
      <li><i class='bx bx-microphone'></i> Micrófono</li>
    </ul>
    <p class="note">El navegador te pedirá permiso en breve.</p>
  </div>
</div>

<!-- Modal: Participantes -->
<app-participants-modal
  *ngIf="showParticipantsModal"
  [participants]="jitsiParticipants"
  (closeModal)="closeParticipantsModal()">
</app-participants-modal>

<!-- Modal: Documentos -->
<app-documents-modal
  *ngIf="showDocumentsModal"
  [sessionId]="sessionId"
  [isModerator]="videoCallData?.isModerator || false"
  [currentUserId]="0"
  (closeModal)="closeDocumentsModal()">
</app-documents-modal>

<!-- Modal: End Session Confirmation (Only for Instructor) -->
<div *ngIf="showEndSessionModal" class="modal-overlay" (click)="closeEndSessionModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Finalizar Sesión</h2>
      <button class="modal-close" (click)="closeEndSessionModal()">
        <i class='bx bx-x'></i>
      </button>
    </div>
    <div class="modal-body">
      <p>¿Qué deseas hacer?</p>
      <p *ngIf="isRecording" class="warning-text">
        <i class='bx bx-error-circle'></i>
        La grabación se detendrá automáticamente
      </p>
    </div>
    <div class="modal-actions">
      <button class="modal-btn btn-danger" (click)="endSessionForEveryone()">
        <i class='bx bx-stop-circle'></i>
        Finalizar para todos
      </button>
      <button class="modal-btn btn-secondary" (click)="leaveSessionOnly()">
        <i class='bx bx-exit'></i>
        Solo abandonar
      </button>
      <button class="modal-btn btn-cancel" (click)="closeEndSessionModal()">
        Cancelar
      </button>
    </div>
  </div>
</div>
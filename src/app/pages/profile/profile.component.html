<div class="profile-wrapper">
  <!-- Notificación Toast (pop-up bonito) -->
  <div class="toast-notification" 
       [class.show]="showNotification" 
       [class.success]="notificationType === 'success'"
       [class.warning]="notificationType === 'warning'"
       [class.error]="notificationType === 'error'"
       [class.info]="notificationType === 'info'">
    <div class="toast-icon">
      <span *ngIf="notificationType === 'success'">✅</span>
      <span *ngIf="notificationType === 'warning'">⚠️</span>
      <span *ngIf="notificationType === 'error'">❌</span>
      <span *ngIf="notificationType === 'info'">ℹ️</span>
    </div>
    <div class="toast-content">
      <h4 class="toast-title">{{ notificationTitle }}</h4>
      <p class="toast-message">{{ notificationMessage }}</p>
    </div>
    <button class="toast-close" (click)="closeNotification()">✕</button>
  </div>

  <main class="profile-main">
    <!-- Primera fila: Avatar e Información Personal -->
    <div class="profile-grid-top">
      <!-- COLUMNA IZQUIERDA: Avatar -->
      <aside class="avatar-card">
        <div class="profile-photo-section">
          <div class="photo-container">
            <!-- Si hay foto, mostrarla -->
            <img 
              *ngIf="getProfilePhotoUrl()" 
              [src]="getProfilePhotoUrl()!" 
              [alt]="profileService.person$().fullName"
              class="profile-photo"
            />
            
            <!-- Si no hay foto, mostrar iniciales -->
            <div 
              *ngIf="!getProfilePhotoUrl()" 
              class="avatar-initials"
            >
              {{ getInitials(profileService.person$().fullName) }}
            </div>
            
            <!-- Indicador de carga -->
            <div *ngIf="isUploadingPhoto" class="upload-overlay">
              <div class="spinner"></div>
            </div>
            
            <!-- Botón para cambiar foto -->
            <button 
              type="button"
              class="change-photo-btn"
              (click)="triggerFileInput()"
              [disabled]="isUploadingPhoto"
              title="Cambiar foto de perfil"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
              </svg>
            </button>
          </div>
          
          <!-- Input oculto para seleccionar archivo -->
          <input 
            type="file" 
            id="profilePhotoInput"
            accept="image/*"
            (change)="onFileSelected($event)"
            style="display: none;"
          />
        </div>
        
        <h3 class="user-role">{{ profileService.getUserRole() }}</h3>
      </aside>

      <!-- COLUMNA DERECHA: Información Personal -->
      <section class="info-card">
        <div class="card-header">
          <h3 class="section-title">Información personal</h3>
          
          <button 
            *ngIf="!isEditingPersonalInfo" 
            (click)="enablePersonalInfoEdit()"
            class="btn-edit"
          >
            Editar
          </button>
          
          <button 
            *ngIf="isEditingPersonalInfo" 
            (click)="savePersonalInfo()"
            class="btn-save"
          >
            <box-icon name='check' color='white' size='18px'></box-icon>
            Guardar
          </button>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>Nombre</label>
            <input 
              type="text" 
              [value]="getFirstName()" 
              placeholder="Nombre"
              readonly
            />
          </div>

          <div class="form-group">
            <label>Apellidos</label>
            <input 
              type="text" 
              [value]="getLastNames()" 
              placeholder="Apellidos"
              readonly
            />
          </div>

          <div class="form-group">
            <label>Correo electrónico</label>
            <input 
              type="email" 
              [value]="profileService.person$().email || ''" 
              placeholder="Correo electrónico"
              readonly
            />
          </div>

          <div class="form-group">
            <label>Idioma preferido</label>
            <select 
              [(ngModel)]="selectedLanguage" 
              [disabled]="!isEditingPersonalInfo"
              class="language-select"
            >
              <option value="es">Español</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>
      </section>
    </div>

    <!-- Segunda fila: Habilidades a explorar -->
    <section class="info-card skills-card">
      <div class="card-header">
        <h3 class="section-title">Habilidades a explorar</h3>
        
        <button 
          *ngIf="!isEditingSkills" 
          (click)="enableSkillsEdit()"
          class="btn-edit-skills"
        >
          Editar habilidades
        </button>
      </div>

      <p class="card-subtitle">
        Ajusta tus habilidades a explorar para poder mostrarte contenido a tu medida.
      </p>

      <!-- Grid dinámico con TODAS las knowledge areas -->
      <div class="skills-grid">
        <div class="form-group" *ngFor="let area of getAllKnowledgeAreas(); trackBy: trackByAreaId">
          <label>{{ getAreaDisplayName(area.name) }}</label>
          
          <!-- MODO VISTA -->
          <div class="select-with-tags" *ngIf="!isEditingSkills">
            <div class="tags-container" *ngIf="getSkillsForArea(area.name).length > 0">
              <span 
                class="tag-pill" 
                *ngFor="let userSkill of getSkillsForArea(area.name); trackBy: trackBySkillId"
              >
                {{ userSkill.skill?.name }}
              </span>
            </div>
            <span class="select-placeholder" *ngIf="getSkillsForArea(area.name).length === 0">
              Selecciona opciones
            </span>
            <box-icon name='chevron-down' size="20px" color="#aae16b" class="select-arrow"></box-icon>
          </div>

          <!-- MODO EDICIÓN -->
          <div class="select-with-tags-editable" *ngIf="isEditingSkills">
            <div class="tags-container-editable">
              <span 
                class="tag-pill-editable" 
                *ngFor="let userSkill of getSkillsForArea(area.name); trackBy: trackBySkillId"
              >
                {{ userSkill.skill?.name }}
                <button 
                  (click)="removeSkill(userSkill)"
                  class="tag-remove-btn"
                  title="Eliminar skill"
                >
                  ✕
                </button>
              </span>
              
              <button 
                (click)="openSkillDropdown(area)"
                type="button"
                class="btn-add-skill"
              >
                Agregar
              </button>
            </div>

            <!-- Dropdown de skills disponibles -->
            <div 
              *ngIf="selectedArea?.id === area.id && showSkillDropdown"
              class="skills-dropdown"
            >
              <div 
                *ngFor="let skill of getAvailableSkillsForArea(area.name); trackBy: trackBySkillOptionId"
                (click)="addSkillToArea(skill)"
                class="skill-option"
              >
                {{ skill.name }}
              </div>
              <div 
                *ngIf="getAvailableSkillsForArea(area.name).length === 0"
                class="no-skills-message"
              >
                No hay más skills disponibles en esta categoría
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Botones de guardar/cancelar -->
      <div *ngIf="isEditingSkills" class="actions-footer">
        <button (click)="cancelSkillsEdit()" class="btn-cancel">
          Cancelar
        </button>
        <button (click)="saveSkills()" class="btn-confirm">
          Guardar cambios
        </button>
      </div>
    </section>
  </main>
</div>
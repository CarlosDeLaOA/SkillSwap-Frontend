<!-- forgot-password.component.html -->
<div class="fp-container">
  <section class="brand-side">
    <img src="assets/img/Logo.png" alt="SkillSwap" class="brand-logo" />
  </section>

  <section class="form-side">
    <div *ngIf="message()" class="alert ok">{{ message() }}</div>
    <div *ngIf="error()" class="alert error">{{ error() }}</div>

    <!-- Panel Email -->
    <div class="panel" [class.open]="openPanel()==='email'" #emailPanel>
      <button class="panel-header" type="button" (click)="toggle('email')">
        <span class="chev" aria-hidden="true">▾</span>
        <span class="title accent-green">Cambio de contraseña</span>
      </button>
      <div class="panel-body">
        <p class="helper">Ingresa tu correo electrónico para confirmar tu identidad.</p>
        <form [formGroup]="emailForm" (ngSubmit)="sendEmail()" class="stack">
          <input formControlName="email" type="email" placeholder="Correo" />
          <div class="hint" *ngIf="emailForm.controls.email.touched && emailForm.controls.email.invalid">
            Correo inválido.
          </div>
          <button class="btn primary" type="submit" [disabled]="loading()">
            {{ loading() ? 'Enviando…' : 'Enviar' }}
          </button>
        </form>
      </div>
    </div>

    <!-- Panel Code -->
    <div class="panel" [class.open]="openPanel()==='code'" #codePanel>
      <button class="panel-header" type="button" (click)="toggle('code')" [class.disabled]="!canOpenCode()"
        [attr.aria-disabled]="!canOpenCode()">
        <span class="chev" aria-hidden="true">▾</span>
        <span class="title">Comprobar código</span>
      </button>

      <div class="panel-body">
        <form [formGroup]="codeForm" (ngSubmit)="verifyCode()" class="stack">
          <input #codeInput formControlName="code" type="text" inputmode="numeric" placeholder="Código"
            [disabled]="!canOpenCode()" />

          <div class="hint" *ngIf="codeForm.controls.code.touched && codeForm.controls.code.invalid">
            Ingresa el código recibido (6 dígitos).
          </div>

          <button class="btn primary" type="submit" [disabled]="loading() || !canOpenCode()">
            {{ loading() ? 'Verificando…' : 'Verificar' }}
          </button>
        </form>

        <div class="resend-row">
          <button class="btn secondary" type="button" (click)="resendCode()" [disabled]="!canResend()">
            Reenviar código
          </button>

          <span class="cooldown" *ngIf="cooldown() > 0">
            Puedes reenviar en {{ cooldown() }}s
          </span>
        </div>
      </div>
    </div>

    <!-- Panel Nueva Contraseña -->
    <div class="panel" [class.open]="openPanel()==='new'" #newPanel>
      <button class="panel-header" type="button" (click)="toggle('new')" [class.disabled]="!canOpenNew()"
        [attr.aria-disabled]="!canOpenNew()">
        <span class="chev" aria-hidden="true">▾</span>
        <span class="title">Nueva contraseña</span>
      </button>
      
      <div class="panel-body">
        <form [formGroup]="newPwdForm" (ngSubmit)="setNewPassword()" class="stack">
          <input #pwdInput 
                 type="password" 
                 placeholder="Nueva contraseña" 
                 formControlName="password"
                 (input)="onPasswordChange()"
                 [disabled]="!canOpenNew()" />
          
          <!-- Mensaje de error de validación de contraseña -->
          <div class="hint error-hint" *ngIf="passwordValidationError() && newPwdForm.controls.password.touched">
            {{ passwordValidationError() }}
          </div>
          
          <input type="password" 
                 placeholder="Confirmar contraseña" 
                 formControlName="confirm"
                 [disabled]="!canOpenNew()" />
          
          <!-- Mensaje de contraseñas no coinciden -->
          <div class="hint error-hint" *ngIf="newPwdForm.controls.confirm.touched && !passwordsMatch() && canOpenNew()">
            Las contraseñas no coinciden.
          </div>
          
          <button class="btn primary" type="submit" [disabled]="loading() || !canOpenNew()">
            {{ loading() ? 'Guardando…' : 'Guardar' }}
          </button>
        </form>
      </div>
    </div>

    <a routerLink="/login" class="back-link">Volver a iniciar sesión</a>
  </section>
</div>

<div class="fp-container">
  <!-- Lado izquierdo - Hero Section -->
  <section class="brand-side">
    <div class="hero-content">
      <h1 class="hero-title">
        Recupera tu<br />
        <span class="highlight">contraseña</span>
      </h1>
    </div>
  </section>

  <!-- Lado derecho - Formulario -->
  <section class="form-side">
    <div class="form-wrapper">
      <h2 class="form-title">Cambio de contraseña</h2>

      <div *ngIf="message()" class="alert ok">{{ message() }}</div>
      <div *ngIf="error()" class="alert error">{{ error() }}</div>

      <!-- Panel Email -->
      <div class="panel" [class.open]="openPanel()==='email'" #emailPanel>
        <button class="panel-header" type="button" (click)="toggle('email')">
          <span class="chev" aria-hidden="true">▾</span>
          <span class="title accent-green">Email</span>
        </button>
        <div class="panel-body">
          <p class="helper">Ingresa tu correo electrónico para confirmar tu identidad.</p>
          <form [formGroup]="emailForm" (ngSubmit)="sendEmail()" class="stack">
            <div class="form-group">
              <input 
                formControlName="email" 
                type="email" 
                placeholder="Correo electrónico"
                [ngClass]="{
                  'is-invalid': emailForm.controls.email.invalid && emailForm.controls.email.touched,
                  'is-valid': emailForm.controls.email.valid && emailForm.controls.email.touched
                }"
              />
              <div class="error-message" *ngIf="emailForm.controls.email.touched && emailForm.controls.email.invalid">
                <span>Correo inválido.</span>
              </div>
            </div>
            <button class="btn primary" type="submit" [disabled]="loading()">
              {{ loading() ? 'Enviando…' : 'Enviar' }}
            </button>
          </form>
        </div>
      </div>

      <!-- Panel Code -->
      <div class="panel" [class.open]="openPanel()==='code'" #codePanel>
        <button class="panel-header" type="button" (click)="toggle('code')" [class.disabled]="!canOpenCode()"
          [attr.aria-disabled]="!canOpenCode()">
          <span class="chev" aria-hidden="true">▾</span>
          <span class="title">Verificar código</span>
        </button>

        <div class="panel-body">
          <p class="helper">Ingresa el código que recibiste en tu correo.</p>
          <form [formGroup]="codeForm" (ngSubmit)="verifyCode()" class="stack">
            <div class="form-group">
              <input 
                #codeInput 
                formControlName="code" 
                type="text" 
                inputmode="numeric" 
                placeholder="Código (6 dígitos)"
                [disabled]="!canOpenCode()"
                [ngClass]="{
                  'is-invalid': codeForm.controls.code.invalid && codeForm.controls.code.touched,
                  'is-valid': codeForm.controls.code.valid && codeForm.controls.code.touched
                }"
              />
              <div class="error-message" *ngIf="codeForm.controls.code.touched && codeForm.controls.code.invalid">
                <span>Ingresa el código recibido (6 dígitos).</span>
              </div>
            </div>

            <button class="btn primary" type="submit" [disabled]="loading() || !canOpenCode()">
              {{ loading() ? 'Verificando…' : 'Verificar' }}
            </button>
          </form>

          <div class="resend-row">
            <button class="btn secondary" type="button" (click)="resendCode()" [disabled]="!canResend()">
              Reenviar código
            </button>

            <span class="cooldown" *ngIf="cooldown() > 0">
              Puedes reenviar en {{ cooldown() }}s
            </span>
          </div>
        </div>
      </div>

      <!-- Panel Nueva Contraseña -->
      <div class="panel" [class.open]="openPanel()==='new'" #newPanel>
        <button class="panel-header" type="button" (click)="toggle('new')" [class.disabled]="!canOpenNew()"
          [attr.aria-disabled]="!canOpenNew()">
          <span class="chev" aria-hidden="true">▾</span>
          <span class="title">Nueva contraseña</span>
        </button>
        
        <div class="panel-body">
          <form [formGroup]="newPwdForm" (ngSubmit)="setNewPassword()" class="stack">
            <div class="form-group">
              <input 
                #pwdInput 
                type="password" 
                placeholder="Nueva contraseña" 
                formControlName="password"
                (input)="onPasswordChange()"
                [disabled]="!canOpenNew()"
                [ngClass]="{
                  'is-invalid': (newPwdForm.controls.password.invalid && newPwdForm.controls.password.touched) || (passwordValidationError() && newPwdForm.controls.password.touched),
                  'is-valid': newPwdForm.controls.password.valid && newPwdForm.controls.password.touched && !passwordValidationError()
                }"
              />
              
              <div class="error-message" *ngIf="passwordValidationError() && newPwdForm.controls.password.touched">
                <span>{{ passwordValidationError() }}</span>
              </div>
            </div>
            
            <div class="form-group">
              <input 
                type="password" 
                placeholder="Confirmar contraseña" 
                formControlName="confirm"
                [disabled]="!canOpenNew()"
                [ngClass]="{
                  'is-invalid': newPwdForm.controls.confirm.invalid && newPwdForm.controls.confirm.touched,
                  'is-valid': newPwdForm.controls.confirm.valid && newPwdForm.controls.confirm.touched
                }"
              />
              
              <div class="error-message" *ngIf="newPwdForm.controls.confirm.touched && !passwordsMatch() && canOpenNew()">
                <span>Las contraseñas no coinciden.</span>
              </div>
            </div>
            
            <button class="btn primary" type="submit" [disabled]="loading() || !canOpenNew()">
              {{ loading() ? 'Guardando…' : 'Guardar' }}
            </button>
          </form>
        </div>
      </div>

      <a routerLink="/login" class="back-link">Volver a iniciar sesión</a>
    </div>
  </section>
</div>